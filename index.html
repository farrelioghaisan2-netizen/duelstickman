<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stickman Saber Duel - Multi Round</title>
    <style>
        body {
            margin: 0;
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            user-select: none;
        }

        #gameContainer {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 1024px;
            aspect-ratio: 16/9;
        }

        canvas {
            background-color: #000;
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Layer Utama */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
        }

        /* Health Bars */
        .health-bar-container {
            width: 40%;
            height: 30px;
            background-color: #333;
            border: 2px solid #555;
            position: relative;
        }

        .health-bar {
            height: 100%;
            width: 100%;
            transition: width 0.1s;
        }

        #p1Health { background: linear-gradient(90deg, #0055ff, #00aaff); box-shadow: 0 0 10px #00aaff; }
        #p2Health { background: linear-gradient(90deg, #ff0000, #ff5555); box-shadow: 0 0 10px #ff5555; float: right;}

        /* Tengah UI: Timer dan Info Ronde */
        .center-ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            text-align: center;
            line-height: 1.1;
        }

        #timer {
            font-size: 40px;
            font-weight: bold;
            text-shadow: 0 0 10px white;
        }

        #roundInfo {
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: -5px;
        }

        /* Display Score */
        .score-display {
            position: absolute;
            top: 60px; /* Di bawah Health Bar */
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 200px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 5px #aaa;
            pointer-events: none;
        }
        .score-label { font-size: 14px; color: #888; }
        .p1-score, .p2-score { text-align: center; }


        #displayText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 60px;
            display: none;
            text-shadow: 0 0 20px white;
            text-align: center;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
        }
        
        .controls-hint {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: #888;
            font-size: 12px;
            background: rgba(0,0,0,0.5);
            padding: 5px;
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <div class="ui-layer">
        <div class="health-bar-container"><div id="p1Health" class="health-bar"></div></div>
        <div class="center-ui">
            <div id="timer">60</div>
            <div id="roundInfo">Ronde <span id="roundDisplay">1</span>/3</div>
        </div>
        <div class="health-bar-container"><div id="p2Health" class="health-bar"></div></div>
    </div>

    <div class="score-display">
        <div class="p1-score"><span class="score-label">P1 Wins:</span> <span id="p1ScoreDisplay">0</span></div>
        <div class="p2-score"><span class="score-label">P2 Wins:</span> <span id="p2ScoreDisplay">0</span></div>
    </div>

    <div id="displayText">Match Over!</div>
    <div class="controls-hint">
        P1 (Biru): <b>A/D</b> (Gerak) <b>W</b> (Lompat) <b>SPASI</b> (Serang) <br>
        P2 (Merah): <b>Panah Kiri/Kanan</b> (Gerak) <b>Atas</b> (Lompat) <b>ENTER</b> (Serang)
    </div>
    <canvas id="gameCanvas"></canvas>
</div>

<script>
    const canvas = document.querySelector('canvas');
    const c = canvas.getContext('2d');

    // --- KONFIGURASI GAME ---
    canvas.width = 1024;
    canvas.height = 576;
    const gravity = 0.7;
    const maxWins = 2; // Pemenang Match adalah yang pertama mencapai 2 kemenangan
    
    // --- STATE GAME ---
    let timer = 60;
    let timerId;
    let isGameRunning = false;
    let currentRound = 1;
    let p1Score = 0;
    let p2Score = 0;
    let matchOver = false;

    // --- KELAS FIGHTER (Stickman) ---
    class Fighter {
        constructor({ position, velocity, color, offset, isPlayer1 }) {
            this.position = position;
            this.velocity = velocity;
            this.width = 40;
            this.height = 100;
            this.lastKey;
            this.attackBox = {
                position: { x: this.position.x, y: this.position.y },
                offset: offset,
                width: 140,
                height: 50
            };
            this.color = color;
            this.isAttacking = false;
            this.health = 100;
            this.isPlayer1 = isPlayer1;
            this.facingRight = isPlayer1;
            this.dead = false;
        }

        draw() {
            // 1. GAMBAR JUBAH (CAPE)
            if (!this.dead) {
                let capeDirection = this.facingRight ? -1 : 1;
                let windLift = Math.abs(this.velocity.x) * 4; 
                let windLag = -(this.velocity.x * 2);

                c.fillStyle = this.isPlayer1 ? '#001a33' : '#330000'; // Warna Jubah
                c.beginPath();
                c.moveTo(this.position.x + 25, this.position.y + 25); // Titik leher
                
                c.lineTo(this.position.x + 25 + (35 * capeDirection) + windLag, this.position.y + 85 - windLift); 
                c.lineTo(this.position.x + 25 + (10 * capeDirection) + windLag, this.position.y + 85); 
                
                c.fill();
            }

            // 2. HP BAR MELAYANG (FLOATING HP)
            if (!this.dead) {
                c.fillStyle = '#444';
                c.fillRect(this.position.x - 10, this.position.y - 25, 60, 6);

                const hpWidth = (this.health / 100) * 60;
                const finalWidth = Math.max(0, hpWidth);
                
                c.fillStyle = this.health > 30 ? '#00ff00' : '#ff0000';
                c.fillRect(this.position.x - 10, this.position.y - 25, finalWidth, 6);
                
                c.strokeStyle = 'black';
                c.lineWidth = 1;
                c.strokeRect(this.position.x - 10, this.position.y - 25, 60, 6);
            }

            // 3. GAMBAR BADAN STICKMAN
            c.strokeStyle = 'white';
            c.lineWidth = 3;
            c.beginPath();
            
            // Kepala
            c.arc(this.position.x + 25, this.position.y + 10, 15, 0, Math.PI * 2);
            
            // Badan
            c.moveTo(this.position.x + 25, this.position.y + 25);
            c.lineTo(this.position.x + 25, this.position.y + 70);

            // Kaki
            c.moveTo(this.position.x + 25, this.position.y + 70);
            c.lineTo(this.position.x + 10, this.position.y + 100);
            c.moveTo(this.position.x + 25, this.position.y + 70);
            c.lineTo(this.position.x + 40, this.position.y + 100);

            // Tangan
            let handX = this.facingRight ? this.position.x + 45 : this.position.x + 5;
            c.moveTo(this.position.x + 25, this.position.y + 35);
            c.lineTo(handX, this.position.y + 50);

            c.stroke();

            // 4. GAMBAR AKSESORIS TOPENG/MATA
            if (!this.dead) {
                if (this.isPlayer1) {
                    // --- PLAYER 1: CYBER VISOR ---
                    c.shadowBlur = 10;
                    c.shadowColor = '#00ffff';
                    c.fillStyle = '#00ffff'; 
                    let visorStart = this.facingRight ? this.position.x + 18 : this.position.x + 12;
                    let visorWidth = 20;
                    c.fillRect(visorStart, this.position.y + 6, visorWidth, 4);
                    c.shadowBlur = 0;
                } else {
                    // --- PLAYER 2: TACTICAL X MASK ---
                    c.strokeStyle = '#ff0000';
                    c.lineWidth = 2;
                    c.beginPath();
                    let centerX = this.position.x + 25;
                    let centerY = this.position.y + 10;
                    c.moveTo(centerX - 6, centerY - 6);
                    c.lineTo(centerX + 6, centerY + 6);
                    c.moveTo(centerX + 6, centerY - 6);
                    c.lineTo(centerX - 6, centerY + 6);
                    c.stroke();
                }
            }

            // 5. GAMBAR LIGHTSABER (SENJATA)
            if (!this.dead) {
                c.shadowBlur = 15;
                c.shadowColor = this.color;
                c.strokeStyle = this.color;
                c.lineWidth = 4;
                c.beginPath();
                c.moveTo(handX, this.position.y + 50);
                
                let saberTipX = handX + (this.facingRight ? 60 : -60);
                let saberTipY = this.position.y + 10;
                
                if (this.isAttacking) {
                    saberTipY = this.position.y + 60;
                    saberTipX = handX + (this.facingRight ? 80 : -80);
                }

                c.lineTo(saberTipX, saberTipY);
                c.stroke();
                
                c.shadowBlur = 0;
            }
        }

        update() {
            this.draw();
            
            if (!this.dead) {
                this.attackBox.position.x = this.position.x + this.attackBox.offset.x;
                this.attackBox.position.y = this.position.y + this.attackBox.offset.y;

                if (this.isPlayer1) {
                    if (keys.a.pressed && this.lastKey === 'a') this.facingRight = false;
                    if (keys.d.pressed && this.lastKey === 'd') this.facingRight = true;
                } else {
                    if (keys.ArrowLeft.pressed && this.lastKey === 'ArrowLeft') this.facingRight = false;
                    if (keys.ArrowRight.pressed && this.lastKey === 'ArrowRight') this.facingRight = true;
                }

                if (!this.facingRight) {
                     this.attackBox.position.x = this.position.x - this.attackBox.width + this.width - this.attackBox.offset.x;
                }

                this.position.x += this.velocity.x;
                this.position.y += this.velocity.y;

                if (this.position.y + this.height + this.velocity.y >= canvas.height - 50) {
                    this.velocity.y = 0;
                    this.position.y = canvas.height - 50 - this.height;
                } else {
                    this.velocity.y += gravity;
                }
                
                if (this.position.x < 0) this.position.x = 0;
                if (this.position.x + this.width > canvas.width) this.position.x = canvas.width - this.width;
            }
        }

        attack() {
            if(!this.isAttacking) {
                this.isAttacking = true;
                setTimeout(() => {
                    this.isAttacking = false;
                }, 100);
            }
        }
    }

    // --- INSTANSIASI PLAYERS ---
    const player = new Fighter({
        position: { x: 200, y: 0 },
        velocity: { x: 0, y: 0 },
        color: '#00ccff', 
        offset: { x: 0, y: 20 },
        isPlayer1: true
    });

    const enemy = new Fighter({
        position: { x: 750, y: 0 },
        velocity: { x: 0, y: 0 },
        color: '#ff0044', 
        offset: { x: -50, y: 20 },
        isPlayer1: false
    });

    const keys = {
        a: { pressed: false },
        d: { pressed: false },
        ArrowRight: { pressed: false },
        ArrowLeft: { pressed: false }
    };

    // --- FUNGSI UTILITY ---

    function rectangularCollision({ rectangle1, rectangle2 }) {
        return (
            rectangle1.attackBox.position.x + rectangle1.attackBox.width >= rectangle2.position.x &&
            rectangle1.attackBox.position.x <= rectangle2.position.x + rectangle2.width &&
            rectangle1.attackBox.position.y + rectangle1.attackBox.height >= rectangle2.position.y &&
            rectangle1.attackBox.position.y <= rectangle2.position.y + rectangle2.height
        );
    }

    function resetPlayerPositions() {
        player.health = 100;
        enemy.health = 100;
        document.querySelector('#p1Health').style.width = '100%';
        document.querySelector('#p2Health').style.width = '100%';

        player.position.x = 200;
        player.position.y = 0;
        enemy.position.x = 750;
        enemy.position.y = 0;
        
        player.velocity.x = 0;
        player.velocity.y = 0;
        enemy.velocity.x = 0;
        enemy.velocity.y = 0;
        
        player.dead = false;
        enemy.dead = false;
    }

    function nextRound() {
        if (p1Score === maxWins || p2Score === maxWins) {
            // Game selesai, Match Over
            return;
        }

        // Reset state untuk ronde baru
        resetPlayerPositions();
        timer = 60;
        document.querySelector('#timer').innerHTML = timer;
        document.querySelector('#roundDisplay').innerHTML = currentRound;
        document.querySelector('#displayText').style.display = 'none';
        isGameRunning = true;
        decreaseTimer();
        animate(); // Pastikan animasi berjalan
    }


    function determineWinner({ winnerName, isDraw }) {
        if (!isGameRunning) return; // Mencegah pemanggilan berulang

        clearTimeout(timerId);
        isGameRunning = false;
        
        const displayTextElement = document.querySelector('#displayText');
        displayTextElement.style.display = 'flex';

        if (isDraw) {
            displayTextElement.innerHTML = 'ROUND DRAW!';
        } else if (winnerName === 'Player 1') {
            p1Score++;
            displayTextElement.innerHTML = `RONDE ${currentRound} - PLAYER 1 MENANG!`;
        } else if (winnerName === 'Player 2') {
            p2Score++;
            displayTextElement.innerHTML = `RONDE ${currentRound} - PLAYER 2 MENANG!`;
        }
        
        // Update skor
        document.querySelector('#p1ScoreDisplay').innerHTML = p1Score;
        document.querySelector('#p2ScoreDisplay').innerHTML = p2Score;
        
        // Cek Pemenang Match
        if (p1Score === maxWins || p2Score === maxWins) {
            const matchWinner = p1Score === maxWins ? 'PLAYER 1' : 'PLAYER 2';
            displayTextElement.innerHTML = `MATCH SELESAI!<br>${matchWinner} MEMENANGKAN PERTANDINGAN! <br>Skor Akhir ${p1Score}-${p2Score}`;
            matchOver = true;
        } else {
            // Lanjut ke ronde berikutnya
            currentRound++;
            setTimeout(nextRound, 3000); // Tunggu 3 detik sebelum memulai ronde baru
        }
    }


    function decreaseTimer() {
        if (timer > 0 && isGameRunning) {
            timerId = setTimeout(decreaseTimer, 1000);
            timer--;
            document.querySelector('#timer').innerHTML = timer;
        }
        
        if (timer === 0) {
            // Penentuan pemenang berdasarkan Health
            if (player.health === enemy.health) {
                 determineWinner({ isDraw: true });
            } else if (player.health > enemy.health) {
                determineWinner({ winnerName: 'Player 1', isDraw: false });
            } else {
                determineWinner({ winnerName: 'Player 2', isDraw: false });
            }
        }
    }

    // --- ANIMASI GAME LOOP ---
    function animate() {
        if (matchOver) return;

        window.requestAnimationFrame(animate);
        
        c.fillStyle = 'rgba(0, 0, 0, 0.4)'; 
        c.fillRect(0, 0, canvas.width, canvas.height);
        
        c.fillStyle = '#222';
        c.fillRect(0, canvas.height - 50, canvas.width, 50);

        player.update();
        enemy.update();

        if (isGameRunning) {
            // Player 1 Movement
            player.velocity.x = 0;
            if (keys.a.pressed && player.lastKey === 'a') {
                player.velocity.x = -6;
            } else if (keys.d.pressed && player.lastKey === 'd') {
                player.velocity.x = 6;
            }

            // Player 2 Movement
            enemy.velocity.x = 0;
            if (keys.ArrowLeft.pressed && enemy.lastKey === 'ArrowLeft') {
                enemy.velocity.x = -6;
            } else if (keys.ArrowRight.pressed && enemy.lastKey === 'ArrowRight') {
                enemy.velocity.x = 6;
            }

            // Collision Check
            if (rectangularCollision({ rectangle1: player, rectangle2: enemy }) && player.isAttacking) {
                player.isAttacking = false;
                enemy.health -= 10;
                if(enemy.health < 0) enemy.health = 0;
                document.querySelector('#p2Health').style.width = enemy.health + '%';
            }

            if (rectangularCollision({ rectangle1: enemy, rectangle2: player }) && enemy.isAttacking) {
                enemy.isAttacking = false;
                player.health -= 10;
                if(player.health < 0) player.health = 0;
                document.querySelector('#p1Health').style.width = player.health + '%';
            }

            // Check K.O. (Health <= 0)
            if (enemy.health <= 0) {
                determineWinner({ winnerName: 'Player 1', isDraw: false });
            } else if (player.health <= 0) {
                determineWinner({ winnerName: 'Player 2', isDraw: false });
            }
        } else {
             // Jika game tidak berjalan (setelah K.O. atau timer habis)
             // Tampilkan pesan "Press ENTER to restart match" jika matchOver = true
             if (matchOver) {
                 c.fillStyle = 'rgba(255, 255, 255, 0.8)';
                 c.font = '20px Courier New';
                 c.textAlign = 'center';
                 c.fillText('Tekan R untuk Main Lagi!', canvas.width / 2, canvas.height / 2 + 80);
             }
        }
    }

    // --- INISIALISASI GAME ---
    // Dipanggil saat game dimuat
    function startGame() {
        currentRound = 1;
        p1Score = 0;
        p2Score = 0;
        matchOver = false;
        document.querySelector('#p1ScoreDisplay').innerHTML = p1Score;
        document.querySelector('#p2ScoreDisplay').innerHTML = p2Score;
        nextRound(); // Mulai ronde pertama
    }

    // --- EVENT LISTENERS ---
    window.addEventListener('keydown', (event) => {
        if (matchOver && event.key === 'r') {
            startGame();
            return;
        }

        if (!isGameRunning || player.dead) return;

        // Player 1
        switch (event.key) {
            case 'd':
                keys.d.pressed = true;
                player.lastKey = 'd';
                break;
            case 'a':
                keys.a.pressed = true;
                player.lastKey = 'a';
                break;
            case 'w':
                if (player.velocity.y === 0) player.velocity.y = -20;
                break;
            case ' ':
                player.attack();
                break;
        }

        // Player 2
        if (!isGameRunning || enemy.dead) return;

        switch (event.key) {
            case 'ArrowRight':
                keys.ArrowRight.pressed = true;
                enemy.lastKey = 'ArrowRight';
                break;
            case 'ArrowLeft':
                keys.ArrowLeft.pressed = true;
                enemy.lastKey = 'ArrowLeft';
                break;
            case 'ArrowUp':
                if (enemy.velocity.y === 0) enemy.velocity.y = -20;
                break;
            case 'Enter':
                enemy.attack();
                break;
        }
    });

    window.addEventListener('keyup', (event) => {
        switch (event.key) {
            case 'd': keys.d.pressed = false; break;
            case 'a': keys.a.pressed = false; break;
        }
        switch (event.key) {
            case 'ArrowRight': keys.ArrowRight.pressed = false; break;
            case 'ArrowLeft': keys.ArrowLeft.pressed = false; break;
        }
    });

    // Mulai game saat halaman dimuat
    startGame();

</script>
</body>
</html>
